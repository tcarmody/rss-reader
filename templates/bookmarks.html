<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Bookmarks - RSS Reader</title>
  <link rel="stylesheet" href="{{ url_for('static', path='css/styles.css') }}">
  <style>
  /* Bookmark styles */
  .bookmarks-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }
  
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .header-actions {
    display: flex;
    gap: 10px;
  }
  </style>
</head>
<body>
<div class="app-container">
  <nav class="nav">
    <div class="nav-container">
      <a href="{{ url_for('index') }}" class="logo" aria-label="Data Points AI Home">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <title>Data Points AI Logo</title>
          <circle cx="12" cy="12" r="10"></circle>
          <path d="M12 6v6l4 2"></path>
        </svg>
        <span class="logo-text">Data Points AI</span>
      </a>
      
      <div class="nav-actions">
        <a href="{{ url_for('welcome') }}" class="button outline">Home / Settings</a>
        <a href="{{ url_for('index') }}" class="button outline">Back to Feed</a>
      </div>
    </div>
  </nav>

  <main class="main wide">
<div class="bookmarks-container">
  <header class="page-header">
    <h1>My Saved Articles</h1>
    <div class="header-actions">
      <div class="dropdown">
        <button class="button primary dropdown-toggle">Export <span class="caret"></span></button>
        <div class="dropdown-menu">
          <a href="/api/bookmarks/export/json" class="dropdown-item">Export as JSON</a>
          <a href="/api/bookmarks/export/csv" class="dropdown-item">Export as CSV</a>
        </div>
      </div>
      <button class="button outline import-btn">Import</button>
    </div>
  </header>
  
  <div class="filters">
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="unread">Unread</button>
      <button class="filter-btn" data-filter="read">Read</button>
    </div>
    
    <div class="tag-filter">
      <input type="text" id="tag-search" placeholder="Filter by tags..." class="form-input">
    </div>
  </div>
  
  <div class="bulk-actions">
    <button id="summarize-all-btn" class="button primary">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="1 9 9 17 23 1"></polyline>
      </svg>
      Summarize All Selected
    </button>
    <div class="selection-info" id="selection-count" style="display: none;">0 articles selected</div>
  </div>
  
  <div class="bookmarks-list">
    {% if bookmarks %}
      {% for bookmark in bookmarks %}
      <div class="bookmark-item {% if bookmark.read_status %}read{% else %}unread{% endif %}" 
           data-id="{{ bookmark.id }}" 
           data-tags="{{ bookmark.tags|join(',') }}">
        <h3 class="bookmark-title">
          <a href="{{ bookmark.url }}" target="_blank" rel="noopener noreferrer">{{ bookmark.title }}</a>
        </h3>
        
        <div class="bookmark-meta">
          <span class="bookmark-date">Saved on {{ bookmark.date_added }}</span>
          {% if bookmark.tags %}
          <div class="bookmark-tags">
            {% for tag in bookmark.tags %}
            <span class="tag">{{ tag }}</span>
            {% endfor %}
          </div>
          {% endif %}
        </div>
        
        {% if bookmark.summary %}
        <div class="bookmark-summary">
          {{ bookmark.summary }}
        </div>
        {% endif %}
        
        <div class="bookmark-actions">
          <label class="checkbox-container">
            <input type="checkbox" class="bookmark-checkbox" data-id="{{ bookmark.id }}" data-url="{{ bookmark.url }}">
            <span class="checkmark"></span>
          </label>
          <button class="summarize-btn button small primary outline" data-id="{{ bookmark.id }}" data-url="{{ bookmark.url }}">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            Summarize
          </button>
          <button class="read-toggle button small outline" data-id="{{ bookmark.id }}" data-status="{{ bookmark.read_status }}">
            {% if bookmark.read_status %}Mark as unread{% else %}Mark as read{% endif %}
          </button>
          <button class="delete-btn button small danger outline" data-id="{{ bookmark.id }}">Delete</button>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty-state">
        <p>You haven't saved any articles yet.</p>
        <p>Browse the <a href="/">feed</a> and click "Save for later" on articles you want to read later.</p>
      </div>
    {% endif %}
  </div>
  
  <!-- Import Modal -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Import Bookmarks</h2>
        <span class="close">&times;</span>
      </div>
      <div class="modal-body">
        <form id="importForm">
          <div class="form-group">
            <label for="importData">Paste JSON data:</label>
            <textarea id="importData" name="json_data" rows="10" class="form-input" required></textarea>
          </div>
          <button type="submit" class="button primary">Import</button>
        </form>
      </div>
    </div>
  </div>
</div>

<style>
  .bookmarks-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
  }
  
  /* Summary modal styles */
  .summary-content {
    padding: 15px;
  }
  
  .loading-spinner {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px;
  }
  
  .spinner {
    border: 4px solid rgba(0, 0, 0, 0.1);
    border-radius: 50%;
    border-top: 4px solid var(--primary-500);
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin-bottom: 15px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .summary-item {
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--neutral-200);
  }
  
  .summary-item:last-child {
    border-bottom: none;
  }
  
  .summary-text {
    margin: 15px 0;
    line-height: 1.6;
  }
  
  .summary-meta {
    font-size: 0.9rem;
    margin-top: 10px;
  }
  
  .error-message {
    color: var(--danger-500);
    padding: 15px;
    background-color: var(--danger-100);
    border-radius: 4px;
  }
  
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  
  .header-actions {
    display: flex;
    gap: 10px;
  }
  
  .filters {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    align-items: center;
  }
  
  .bulk-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 10px;
    background-color: var(--neutral-100);
    border-radius: 4px;
  }
  
  .selection-info {
    font-size: 0.9rem;
    color: var(--neutral-700);
  }
  
  .checkbox-container {
    display: inline-block;
    position: relative;
    padding-left: 25px;
    margin-right: 12px;
    cursor: pointer;
    font-size: 16px;
    user-select: none;
  }
  
  .checkbox-container input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
  }
  
  .checkmark {
    position: absolute;
    top: 0;
    left: 0;
    height: 18px;
    width: 18px;
    background-color: #eee;
    border-radius: 3px;
  }
  
  .checkbox-container:hover input ~ .checkmark {
    background-color: #ccc;
  }
  
  .checkbox-container input:checked ~ .checkmark {
    background-color: var(--primary-500);
  }
  
  .checkmark:after {
    content: "";
    position: absolute;
    display: none;
  }
  
  .checkbox-container input:checked ~ .checkmark:after {
    display: block;
  }
  
  .checkbox-container .checkmark:after {
    left: 6px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }
  
  .filter-buttons {
    display: flex;
    gap: 10px;
  }
  
  .filter-btn {
    padding: 8px 16px;
    border: 1px solid #ddd;
    background: #f5f5f5;
    border-radius: 4px;
    cursor: pointer;
  }
  
  .filter-btn.active {
    background: #007bff;
    color: white;
    border-color: #0069d9;
  }
  
  .tag-filter {
    width: 250px;
  }
  
  .bookmarks-list {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .bookmark-item {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 16px;
    background: white;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  }
  
  .bookmark-item.read {
    opacity: 0.7;
  }
  
  .bookmark-title {
    margin-top: 0;
    margin-bottom: 10px;
  }
  
  .bookmark-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 10px;
  }
  
  .bookmark-tags {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
  }
  
  .tag {
    background: #e9ecef;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
  }
  
  .bookmark-summary {
    margin-bottom: 15px;
    font-size: 0.95rem;
    line-height: 1.5;
  }
  
  .bookmark-actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
  }
  
  .empty-state {
    text-align: center;
    padding: 40px;
    color: #666;
  }
  
  /* Dropdown styles */
  .dropdown {
    position: relative;
    display: inline-block;
  }
  
  .dropdown-menu {
    display: none;
    position: absolute;
    right: 0;
    background-color: white;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 4px;
  }
  
  .dropdown-item {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
  }
  
  .dropdown-item:hover {
    background-color: #f1f1f1;
  }
  
  .dropdown:hover .dropdown-menu {
    display: block;
  }
  
  /* Modal styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
  }
  
  .modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 20px;
    border-radius: 8px;
    width: 60%;
    max-width: 600px;
  }
  
  .close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
  }
  
  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Summarization modal
    const summaryModal = document.createElement('div');
    summaryModal.id = 'summaryModal';
    summaryModal.className = 'modal';
    summaryModal.innerHTML = `
      <div class="modal-content">
        <div class="modal-header">
          <h2>Article Summary</h2>
          <span class="close">&times;</span>
        </div>
        <div class="modal-body">
          <div id="summary-content" class="summary-content">
            <div class="loading-spinner">
              <div class="spinner"></div>
              <p>Generating summary...</p>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(summaryModal);
    
    const closeBtn = summaryModal.querySelector('.close');
    closeBtn.onclick = function() {
      summaryModal.style.display = 'none';
    };
    
    window.onclick = function(event) {
      if (event.target === summaryModal) {
        summaryModal.style.display = 'none';
      } else if (event.target === importModal) {
        importModal.style.display = 'none';
      }
    };
    
    // Filter functionality
    const filterButtons = document.querySelectorAll('.filter-btn');
    const bookmarkItems = document.querySelectorAll('.bookmark-item');
    const tagSearch = document.getElementById('tag-search');
    
    // Filter by read status
    filterButtons.forEach(button => {
      button.addEventListener('click', function() {
        // Update active button
        filterButtons.forEach(btn => btn.classList.remove('active'));
        this.classList.add('active');
        
        const filter = this.dataset.filter;
        
        bookmarkItems.forEach(item => {
          if (filter === 'all') {
            item.style.display = '';
          } else if (filter === 'read') {
            item.style.display = item.classList.contains('read') ? '' : 'none';
          } else if (filter === 'unread') {
            item.style.display = item.classList.contains('unread') ? '' : 'none';
          }
        });
      });
    });
    
    // Filter by tags
    tagSearch.addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();
      
      bookmarkItems.forEach(item => {
        const tags = item.dataset.tags.toLowerCase();
        
        if (searchTerm === '' || tags.includes(searchTerm)) {
          item.style.display = '';
        } else {
          item.style.display = 'none';
        }
      });
    });
    
    // Mark as read/unread
    document.querySelectorAll('.read-toggle').forEach(button => {
      button.addEventListener('click', async function() {
        const id = this.dataset.id;
        const currentStatus = this.dataset.status === 'true';
        const newStatus = !currentStatus;
        
        try {
          const response = await fetch(`/api/bookmarks/${id}/read?status=${newStatus}`, {
            method: 'PUT'
          });
          
          if (response.ok) {
            // Update UI
            const bookmarkItem = this.closest('.bookmark-item');
            if (newStatus) {
              bookmarkItem.classList.remove('unread');
              bookmarkItem.classList.add('read');
              this.textContent = 'Mark as unread';
            } else {
              bookmarkItem.classList.remove('read');
              bookmarkItem.classList.add('unread');
              this.textContent = 'Mark as read';
            }
            this.dataset.status = String(newStatus);
          }
        } catch (error) {
          console.error('Error updating read status:', error);
        }
      });
    });
    
    // Delete bookmark functionality
    const deleteButtons = document.querySelectorAll('.delete-btn');
    deleteButtons.forEach(button => {
      button.addEventListener('click', async function() {
        const bookmarkId = this.dataset.id;
        if (confirm('Are you sure you want to delete this bookmark?')) {
          try {
            const response = await fetch(`/api/bookmarks/${bookmarkId}`, {
              method: 'DELETE',
            });
            
            if (response.ok) {
              // Remove the bookmark item from the DOM
              const bookmarkItem = this.closest('.bookmark-item');
              bookmarkItem.remove();
              
              // Check if there are no more bookmarks
              const remainingBookmarks = document.querySelectorAll('.bookmark-item');
              if (remainingBookmarks.length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.innerHTML = `
                  <p>You haven't saved any articles yet.</p>
                  <p>Browse the <a href="/">feed</a> and click "Save for later" on articles you want to read later.</p>
                `;
                document.querySelector('.bookmarks-list').appendChild(emptyState);
              }
            } else {
              const errorData = await response.json();
              alert(`Error: ${errorData.detail}`);
            }
          } catch (error) {
            console.error('Error deleting bookmark:', error);
            alert('An error occurred while deleting the bookmark.');
          }
        }
      });
    });
    
    // Individual summarize functionality
    const summarizeButtons = document.querySelectorAll('.summarize-btn');
    summarizeButtons.forEach(button => {
      button.addEventListener('click', async function() {
        const bookmarkId = this.dataset.id;
        const url = this.dataset.url;
        
        // Show the summary modal
        summaryModal.style.display = 'block';
        const summaryContent = document.getElementById('summary-content');
        summaryContent.innerHTML = `
          <div class="loading-spinner">
            <div class="spinner"></div>
            <p>Generating summary...</p>
          </div>
        `;
        
        try {
          const response = await fetch('/api/summarize', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ url: url }),
          });
          
          const result = await response.json();
          
          if (response.ok) {
            summaryContent.innerHTML = `
              <h3>${result.title || 'Article Summary'}</h3>
              <div class="summary-text">${result.summary}</div>
              <div class="summary-meta">
                <a href="${url}" target="_blank" rel="noopener noreferrer">View Original Article</a>
              </div>
            `;
            
            // Update the bookmark summary in the database
            await fetch(`/api/bookmarks/${bookmarkId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ summary: result.summary }),
            });
            
            // Update the summary in the DOM
            const bookmarkItem = this.closest('.bookmark-item');
            const summaryElement = bookmarkItem.querySelector('.bookmark-summary');
            if (summaryElement) {
              summaryElement.textContent = result.summary;
            } else {
              const newSummaryElement = document.createElement('div');
              newSummaryElement.className = 'bookmark-summary';
              newSummaryElement.textContent = result.summary;
              bookmarkItem.insertBefore(newSummaryElement, bookmarkItem.querySelector('.bookmark-actions'));
            }
          } else {
            summaryContent.innerHTML = `<div class="error-message">Error: ${result.detail || 'Failed to generate summary'}</div>`;
          }
        } catch (error) {
          console.error('Error summarizing article:', error);
          summaryContent.innerHTML = `<div class="error-message">An error occurred while generating the summary.</div>`;
        }
      });
    });
    
    // Checkbox selection functionality
    const checkboxes = document.querySelectorAll('.bookmark-checkbox');
    const selectionCount = document.getElementById('selection-count');
    const summarizeAllBtn = document.getElementById('summarize-all-btn');
    
    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const checkedBoxes = document.querySelectorAll('.bookmark-checkbox:checked');
        const count = checkedBoxes.length;
        
        if (count > 0) {
          selectionCount.textContent = `${count} article${count === 1 ? '' : 's'} selected`;
          selectionCount.style.display = 'block';
        } else {
          selectionCount.style.display = 'none';
        }
      });
    });
    
    // Bulk summarize functionality
    summarizeAllBtn.addEventListener('click', async function() {
      const checkedBoxes = document.querySelectorAll('.bookmark-checkbox:checked');
      
      if (checkedBoxes.length === 0) {
        alert('Please select at least one article to summarize.');
        return;
      }
      
      // Show the summary modal
      summaryModal.style.display = 'block';
      const summaryContent = document.getElementById('summary-content');
      summaryContent.innerHTML = `
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Generating summaries for ${checkedBoxes.length} article${checkedBoxes.length === 1 ? '' : 's'}...</p>
        </div>
      `;
      
      try {
        const urls = Array.from(checkedBoxes).map(checkbox => checkbox.dataset.url);
        const bookmarkIds = Array.from(checkedBoxes).map(checkbox => checkbox.dataset.id);
        
        const response = await fetch('/api/summarize-batch', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ urls: urls }),
        });
        
        const results = await response.json();
        
        if (response.ok) {
          // Display the summaries in the modal
          let summariesHTML = '<div class="batch-summaries">';
          
          results.summaries.forEach((result, index) => {
            summariesHTML += `
              <div class="summary-item">
                <h3>${result.title || `Article ${index + 1}`}</h3>
                <div class="summary-text">${result.summary}</div>
                <div class="summary-meta">
                  <a href="${urls[index]}" target="_blank" rel="noopener noreferrer">View Original Article</a>
                </div>
              </div>
            `;
            
            // Update the bookmark summary in the database
            fetch(`/api/bookmarks/${bookmarkIds[index]}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ summary: result.summary }),
            });
            
            // Update the summary in the DOM
            const checkbox = document.querySelector(`.bookmark-checkbox[data-id="${bookmarkIds[index]}"]`);
            const bookmarkItem = checkbox.closest('.bookmark-item');
            const summaryElement = bookmarkItem.querySelector('.bookmark-summary');
            
            if (summaryElement) {
              summaryElement.textContent = result.summary;
            } else {
              const newSummaryElement = document.createElement('div');
              newSummaryElement.className = 'bookmark-summary';
              newSummaryElement.textContent = result.summary;
              bookmarkItem.insertBefore(newSummaryElement, bookmarkItem.querySelector('.bookmark-actions'));
            }
          });
          
          summariesHTML += '</div>';
          summaryContent.innerHTML = summariesHTML;
        } else {
          summaryContent.innerHTML = `<div class="error-message">Error: ${results.detail || 'Failed to generate summaries'}</div>`;
        }
      } catch (error) {
        console.error('Error summarizing articles:', error);
        summaryContent.innerHTML = `<div class="error-message">An error occurred while generating the summaries.</div>`;
      }
    });
    
    // Import modal
    const importModal = document.getElementById('importModal');
    const importForm = document.getElementById('importForm');
    
    // Show modal when Import button is clicked
    document.querySelector('.import-btn').addEventListener('click', function() {
      importModal.style.display = 'block';
    });
    
    // Close modal
    document.querySelector('.close').addEventListener('click', function() {
      importModal.style.display = 'none';
    });
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
      if (event.target === importModal) {
        importModal.style.display = 'none';
      }
    });
    
    // Handle import form submission
    importForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(importForm);
      
      try {
        const response = await fetch('/api/bookmarks/import', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`Successfully imported ${result.imported} bookmarks. The page will now reload.`);
          importModal.style.display = 'none';
          window.location.reload();
        } else {
          alert(`Error: ${result.detail}`);
        }
      } catch (error) {
        console.error('Error importing bookmarks:', error);
        alert('An error occurred while importing bookmarks.');
      }
    });
  });
</script>
  </main>

  <footer class="footer">
    <p>Powered by Data Points AI with Anthropic Claude API</p>
  </footer>
</div>
</body>
</html>
