<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Points AI - Smart RSS Reader</title>
  <link rel="stylesheet" href="{{ url_for('static', path='css/styles.css') }}">
  </head>
<body>
  <div class="app-container">
    <nav class="nav">
      <div class="nav-container">
        <a href="{{ url_for('index') }}" class="logo" aria-label="Data Points AI Home">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <title>Data Points AI Logo</title>
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M12 6v6l4 2"></path>
          </svg>
          <span class="logo-text">Data Points AI</span>
        </a>
      </div>
    </nav>
    
    <main class="main wide">
      <div class="card">
        <h1 class="card-title">Welcome to Data Points AI</h1>
        <p>Smart AI-powered RSS reader that summarizes and clusters related articles automatically.</p>
        
        <section aria-labelledby="applicationSettingsTitle">
          <h2 id="applicationSettingsTitle" class="card-title" style="margin-top: 2rem;">Application Settings</h2>
          <div class="settings-grid">
            <div class="setting-card">
              <div class="setting-header">
                <svg class="setting-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <title>Paywall Icon</title>
                  <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                  <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                <h3 class="setting-title" id="paywallAccessLabel">Paywall Access</h3>
              </div>
              <p class="setting-description">Enable to attempt reading articles behind paywalls.</p>
              
              <form action="/toggle_paywall_bypass" method="post" id="paywallToggleFormWelcome">
                <div class="toggle-container danger-toggle">
                  <span class="toggle-label">
                    {% if paywall_bypass_enabled %}
                      Enabled
                    {% else %}
                      Disabled
                    {% endif %}
                  </span>
                  <label class="toggle-switch">
                    <input type="checkbox" {% if paywall_bypass_enabled %}checked{% endif %} onChange="this.form.submit()" aria-labelledby="paywallAccessLabel">
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                <p class="warning-text">Warning: Bypassing paywalls may violate some sites' terms of service.</p>
              </form>
            </div>
            
            <div class="setting-card">
              <div class="setting-header">
                <svg class="setting-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <title>RSS Feed Icon</title>
                  <path d="M4 11a9 9 0 0 1 9 9"></path>
                  <path d="M4 4a16 16 0 0 1 16 16"></path>
                  <circle cx="5" cy="19" r="1"></circle>
                </svg>
                <h3 class="setting-title">Feed Processing</h3>
              </div>
              <p class="setting-description">Control how NewsAI processes your RSS feeds.</p>
              
              <form id="globalSettingsForm"> <div class="input-group">
                  <div class="form-group">
                    <label class="form-label" for="global_batch_size">Batch Size</label>
                    <input class="form-input" type="number" id="global_batch_size" name="global_batch_size" value="{% if global_settings is defined %}{{ global_settings.batch_size | default(25) }}{% else %}25{% endif %}" min="1" aria-describedby="batchSizeHint">
                    <p class="form-hint" id="batchSizeHint" style="font-size: 0.75rem; color: var(--neutral-500);">Articles per batch.</p>
                  </div>
                  <div class="form-group">
                    <label class="form-label" for="global_batch_delay">Delay (sec)</label>
                     <input class="form-input" type="number" id="global_batch_delay" name="global_batch_delay" value="{% if global_settings is defined %}{{ global_settings.batch_delay | default(15) }}{% else %}15{% endif %}" min="1" aria-describedby="batchDelayHint">
                    <p class="form-hint" id="batchDelayHint" style="font-size: 0.75rem; color: var(--neutral-500);">Delay between batches.</p>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </section>
        
        <section aria-labelledby="clusteringSettingsTitleFull">
          <div class="clustering-settings-container" style="margin-top: 2rem;">
            <div class="clustering-settings-title">
              <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <title>Clustering Icon</title>
                <circle cx="18" cy="5" r="3"></circle>
                <circle cx="6" cy="12" r="3"></circle>
                <circle cx="18" cy="19" r="3"></circle>
                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
              </svg>
              <h2 id="clusteringSettingsTitleFull">Article Clustering Settings</h2>
            </div>
            
            <form action="/update_clustering_settings" method="post" id="clusteringSettingsForm">
              <div class="setting-row">
                <div>
                  <div class="setting-name" id="multiArticleLabel">Multi-Article Clustering</div>
                  <div class="setting-description">Enable Claude to analyze multiple articles at once</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" name="enable_multi_article" {% if clustering_settings is defined and clustering_settings.enable_multi_article %}checked{% endif %} aria-labelledby="multiArticleLabel">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="setting-row">
                <div>
                  <div class="setting-name" id="enhancedClusteringLabel">Enhanced Clustering</div>
                  <div class="setting-description">Use advanced clustering algorithms</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" name="use_enhanced_clustering" {% if clustering_settings is defined and clustering_settings.use_enhanced_clustering %}checked{% endif %} aria-labelledby="enhancedClusteringLabel">
                  <span class="toggle-slider"></span>
                </label>
              </div>
              
              <div class="setting-row">
                <div>
                  <div class="setting-name" id="timeRangeFilterLabel">Time Range Filter</div>
                  <div class="setting-description">Only include articles from the selected time range</div>
                </div>
                <label class="toggle-switch">
                  <input type="checkbox" name="time_range_enabled" {% if clustering_settings is defined and clustering_settings.time_range_enabled %}checked{% endif %} aria-labelledby="timeRangeFilterLabel" aria-controls="timeRangeOptions">
                  <span class="toggle-slider"></span>
                </label>
              </div>

              <div class="setting-row" {% if clustering_settings is not defined or not clustering_settings.time_range_enabled %}style="display: none;"{% endif %} id="timeRangeOptions" role="region" aria-labelledby="timeRangeFilterLabel">
                <div>
                  <div class="setting-name">Time Range</div>
                  <div class="setting-description">How far back to look for articles</div>
                </div>
                <div style="display: flex; gap: 0.5rem;">
                  <label for="time_range_value" class="sr-only">Time Range Value</label>
                  <input type="number" id="time_range_value" name="time_range_value" class="form-input-number" value="{% if clustering_settings is defined %}{{ clustering_settings.time_range_value | default(7) }}{% else %}7{% endif %}" min="1" style="max-width: 70px;">
                  <label for="time_range_unit" class="sr-only">Time Range Unit</label>
                  <select id="time_range_unit" name="time_range_unit" class="form-input" style="max-width: 100px;">
                    <option value="hours" {% if clustering_settings is defined and clustering_settings.time_range_unit == 'hours' %}selected{% endif %}>Hours</option>
                    <option value="days" {% if clustering_settings is defined and clustering_settings.time_range_unit == 'days' %}selected{% endif %}>Days</option>
                    <option value="weeks" {% if clustering_settings is defined and clustering_settings.time_range_unit == 'weeks' %}selected{% endif %}>Weeks</option>
                    <option value="months" {% if clustering_settings is defined and clustering_settings.time_range_unit == 'months' %}selected{% endif %}>Months</option>
                  </select>
                </div>
              </div>
              
              <div class="setting-row">
                <div>
                  <label for="similarity_threshold" class="setting-name">Similarity Threshold</label>
                  <div class="setting-description">Minimum similarity score to group articles (0.0-1.0)</div>
                </div>
                <input type="number" id="similarity_threshold" name="similarity_threshold" class="form-input-number" value="{% if clustering_settings is defined %}{{ clustering_settings.similarity_threshold | default(0.7) }}{% else %}0.7{% endif %}" min="0" max="1" step="0.05" style="max-width: 70px;">
              </div>
              
              <div class="setting-row">
                <div>
                  <label for="max_articles_per_batch" class="setting-name">Max Articles Per Cluster Batch</label>
                  <div class="setting-description">Maximum articles to analyze for clustering at once</div>
                </div>
                <input type="number" id="max_articles_per_batch" name="max_articles_per_batch" class="form-input-number" value="{% if clustering_settings is defined %}{{ clustering_settings.max_articles_per_batch | default(5) }}{% else %}5{% endif %}" min="1" max="20" style="max-width: 70px;">
              </div>
              
              <div class="buttons-container">
                <button type="submit" class="button">
                  Save Clustering Settings
                  </button>
                <button type="submit" class="button outline" formaction="/reset_clustering_settings">Reset to Defaults</button>
              </div>
            </form>
          </div>
        </section>
        
        {% if not initial_summaries_loaded %} <div class="info-banner" role="status" style="margin-top: 2rem;">
          <p><strong>No summaries available yet.</strong> Use the options below to process feeds or summarize URLs.</p>
        </div>
        {% endif %}
        
        <section aria-labelledby="summarizeUrlLinkTitle" class="feed-section" style="margin-top: 2rem;">
          <h3 id="summarizeUrlLinkTitle">Summarize Individual URLs</h3>
          <p>Generate an AI-powered summary of any webpage or article.</p>
          <a href="{{ url_for('summarize_single_get') }}" class="button large" style="margin-top: 1rem; display: inline-block; text-align: center;">
            Go to Summarize URL Form
          </a>
        </section>
        
        <section aria-labelledby="feedProcessingTitle" style="margin-top: 2rem;">
          <h2 id="feedProcessingTitle" class="card-title">Feed Management</h2>
          <div class="tabs" role="tablist" aria-label="Feed Management Options">
            <button class="tab active" role="tab" aria-selected="true" aria-controls="default-feeds-panel" id="default-feeds-tab" data-tab="default-feeds-panel">Default Feeds</button>
            <button class="tab" role="tab" aria-selected="false" aria-controls="custom-feeds-panel" id="custom-feeds-tab" data-tab="custom-feeds-panel" tabindex="-1">Custom Feeds</button>
          </div>
          
          <div class="tab-content active" id="default-feeds-panel" role="tabpanel" aria-labelledby="default-feeds-tab">
            {% if has_default_feeds %}
            <div class="feed-section">
              <h3>Process Default Feeds</h3>
              <p>Process articles from the default feed list in <code class="code">rss_feeds.txt</code>.</p>
              <p><span class="strong">Note:</span> This will process all feeds in the list using the global feed processing settings above.</p>
              
              <form action="/refresh" method="post" style="margin-top: 1rem" id="defaultFeedsForm">
                <input type="hidden" name="use_default" value="true">
                <input type="hidden" name="batch_size" id="default_batch_size">
                <input type="hidden" name="batch_delay" id="default_batch_delay">
                <button type="submit" class="button success large">
                  Process Default Feeds
                  </button>
              </form>
            </div>
            {% else %}
            <div class="info-banner" role="status">
              <p>No default feeds found. Please create a <code class="code">rss_feeds.txt</code> file or add custom feeds via the 'Custom Feeds' tab.</p>
            </div>
            {% endif %}
          </div>
          
          <div class="tab-content" id="custom-feeds-panel" role="tabpanel" aria-labelledby="custom-feeds-tab" hidden>
            <h3>Add and Process Custom Feeds</h3>
            <form action="/refresh" method="post" id="customFeedsForm">
              <div class="form-group">
                <label class="form-label" for="feeds">RSS Feed URLs (one per line)</label>
                <textarea class="form-input" id="feeds" name="feeds" placeholder="https://example.com/rss1.xml&#10;https://example.com/rss2.xml" rows="4" aria-describedby="customFeedsHint"></textarea>
                <p class="form-hint" id="customFeedsHint" style="font-size: 0.75rem; color: var(--neutral-500);">Enter one URL per line.</p>
              </div>
              
              <input type="hidden" name="batch_size" id="custom_batch_size">
              <input type="hidden" name="batch_delay" id="custom_batch_delay">
              
              <button type="submit" class="button">
                Process Custom Feeds
                </button>
            </form>
          </div>
        </section>
      </div>
    </main>
    
    <footer class="footer">
      <p>Powered by Data Points AI with Anthropic Claude API</p>
    </footer>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Tab switching functionality
      const tablist = document.querySelector('.tabs[role="tablist"]');
      const tabs = document.querySelectorAll('.tab[role="tab"]');
      const tabPanels = document.querySelectorAll('.tab-content[role="tabpanel"]');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          const clickedTab = e.currentTarget;
          const targetPanelId = clickedTab.getAttribute('aria-controls');
          
          tabs.forEach(t => {
            t.classList.remove('active');
            t.setAttribute('aria-selected', 'false');
            t.setAttribute('tabindex', '-1');
          });
          
          clickedTab.classList.add('active');
          clickedTab.setAttribute('aria-selected', 'true');
          clickedTab.removeAttribute('tabindex');
          
          tabPanels.forEach(panel => {
            if (panel.id === targetPanelId) {
              panel.removeAttribute('hidden');
            } else {
              panel.setAttribute('hidden', '');
            }
          });
          clickedTab.focus(); // Optional: move focus to the activated tab
        });

        tab.addEventListener('keydown', (e) => {
            let index = Array.from(tabs).indexOf(e.currentTarget);
            let newIndex = index;
            if (e.key === 'ArrowRight') {
                newIndex = (index + 1) % tabs.length;
            } else if (e.key === 'ArrowLeft') {
                newIndex = (index - 1 + tabs.length) % tabs.length;
            } else if (e.key === 'Home') {
                newIndex = 0;
            } else if (e.key === 'End') {
                newIndex = tabs.length - 1;
            }

            if (newIndex !== index) {
                tabs[newIndex].click(); // Programmatically click the new tab
                tabs[newIndex].focus();   // And move focus to it
            }
        });
      });
      
      // Synchronize global settings with the form submissions
      const globalBatchSizeInput = document.getElementById('global_batch_size');
      const globalBatchDelayInput = document.getElementById('global_batch_delay');
      const defaultBatchSizeInput = document.getElementById('default_batch_size');
      const defaultBatchDelayInput = document.getElementById('default_batch_delay');
      const customBatchSizeInput = document.getElementById('custom_batch_size');
      const customBatchDelayInput = document.getElementById('custom_batch_delay');
      
      function updateHiddenFields() {
        if (defaultBatchSizeInput) defaultBatchSizeInput.value = globalBatchSizeInput.value;
        if (defaultBatchDelayInput) defaultBatchDelayInput.value = globalBatchDelayInput.value;
        if (customBatchSizeInput) customBatchSizeInput.value = globalBatchSizeInput.value;
        if (customBatchDelayInput) customBatchDelayInput.value = globalBatchDelayInput.value;
      }
      
      if (globalBatchSizeInput && globalBatchDelayInput) {
        updateHiddenFields(); // Initialize
        globalBatchSizeInput.addEventListener('change', updateHiddenFields);
        globalBatchDelayInput.addEventListener('change', updateHiddenFields);
      }
      
      // Update before form submission for forms that use these global settings
      const defaultFeedsForm = document.getElementById('defaultFeedsForm');
      if (defaultFeedsForm) defaultFeedsForm.addEventListener('submit', updateHiddenFields);
      
      const customFeedsForm = document.getElementById('customFeedsForm');
      if (customFeedsForm) customFeedsForm.addEventListener('submit', updateHiddenFields);
      
      // Handle time range options visibility for Clustering Settings
      const timeRangeEnabledToggle = document.querySelector('input[name="time_range_enabled"]');
      const timeRangeOptionsDiv = document.getElementById('timeRangeOptions');
      
      if (timeRangeEnabledToggle && timeRangeOptionsDiv) {
        timeRangeEnabledToggle.addEventListener('change', function() {
          timeRangeOptionsDiv.style.display = this.checked ? 'flex' : 'none';
          timeRangeOptionsDiv.setAttribute('aria-hidden', !this.checked);
        });
        // Initial state set by server-side rendering is now more robust
        // Ensure JS reflects the possibly hidden-by-default state
        if (timeRangeOptionsDiv.style.display === 'none') {
             timeRangeOptionsDiv.setAttribute('aria-hidden', 'true');
        } else {
             timeRangeOptionsDiv.setAttribute('aria-hidden', 'false');
        }
      }

      // Add similar JS for other forms to show loading states if desired.
      // E.g., for clusteringSettingsForm, defaultFeedsForm, customFeedsForm:
      // const formsToTrack = ['clusteringSettingsForm', 'defaultFeedsForm', 'customFeedsForm'];
      // formsToTrack.forEach(formId => {
      //   const form = document.getElementById(formId);
      //   if (form) {
      //     form.addEventListener('submit', function() {
      //       const submitButton = form.querySelector('button[type="submit"]');
      //       const spinner = submitButton.querySelector('.loading-spinner');
      //       if (submitButton) submitButton.disabled = true;
      //       if (spinner) spinner.style.display = 'inline-block';
      //       // Add logic to hide spinner and re-enable button on completion/error
      //     });
      //   }
      // });
    });
  </script>
</body>
</html>